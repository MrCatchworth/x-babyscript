<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GM_Assassination" xmlnsxsi="http://www.w3.org/2001/XMLSchema-instance" xsinoNamespaceSchemaLocation="md.xsd">
  <cues>
    <!--Generic Mission: Assassination
    missiontype.kill
    
    Mission Variation #1: Mass Traffic Criminal
      Licence: None
      Mission Level: 2
      Enemy Faction: Smuggler, Criminal
      -->
    <cue name="Force_Generic" instantiate="true">
      <conditions>
        <event_cue_signalled />
      </conditions>
      <actions>
        <signal_cue cue="md.GenericMissions.RemoveAllOffers" />
      </actions>
      <force name="GM_Assassination" />
      <cues>
        <cue name="Force_Generic_Signals">
          <delay exact="1s" />
          <actions>
            <do_all exact="25">
              <signal_cue_instantly cue="md.GM_Assassination.StartGeneric" param="100" />
            </do_all>
          </actions>
        </cue>
      </cues>
    </cue>
    <cue name="StartGeneric" instantiate="true" namespace="this">
      <conditions>
        <check_any>
          <check_all>
            <event_cue_signalled />
            <check_value value="player.sector" />
            <count_stations space="player.sector" min="1" canhaveofferlocation="tag.mission" hasmasstraffic="true" result="$missionstations">
              <match_relation faction="faction.player" comparison="not" relation="enemy" />
              <match owner="faction.player" negate="true" />
              <match owner="null" negate="true" />
              <match_distance object="player.primaryship" max="md.$MaxMissionOfferDistance" />
            </count_stations>
          </check_all>
          <check_all>
            <event_player_mission_opportunity />
            <check_value value="false" />
          </check_all>
        </check_any>
      </conditions>
      <actions>
        <do_if value="event.name == 'event_cue_signalled'">
          <set_value name="$missionstation" exact="static.$missionstations.{md.$RandomIdx}" />
          <set_value name="$EventOffer" exact="false" />
          <set_value name="$DebugChance" exact="@event.param" />
        </do_if>
        <do_elseif value="event.name == 'event_player_mission_opportunity'">
          <set_value name="$missionstation" exact="event.param" />
          <set_value name="$EventOffer" exact="true" />
          <set_value name="$DebugChance" exact="0" />
        </do_elseif>
      </actions>
      <cues>
        <cue name="StartRef" ref="md.GM_Assassination.Start">
          <param name="MissionStation" value="$missionstation" />
          <param name="EventOffer" value="$EventOffer" />
          <param name="DebugChance" value="$DebugChance" />
        </cue>
      </cues>
    </cue>
    <!--
    The Start Cue will create an offer on a station
    If the offer is accepted, the mission library (ProtectObject) is called
    $Feedback:
    -105: No suitable mission variant
    -104: Unknown mission variant. No TextOffset set
    -103: No target found
    -102: TargetStation does not have masstraffic
    -101: No MissionStation parameter provided
    -100: Undefined failure. Defaulted to -100
    -6: Mission timeout
    -5: Event Offer timeout
    -4: Player declined Event Offer
    -3: Offer removed
    -2: Mission aborted
    -1: Mission failed
    1: Mission suceeded -->
    <library name="Start">
      <params>
        <param name="MissionStation" />
        <param name="Client_Owner" default="null" />
        <param name="RewardCr" default="null" />
        <param name="RewardNotoriety" default="null" />
        <param name="MissionDuration" default="null" />
        <param name="WithoutOffer" default="false" />
        <param name="EventOffer" default="false" />
        <param name="TargetStation" default="null" />
        <param name="TargetShip" default="null" />
        <param name="Page" default="30102" />
        <param name="TextOffset" default="null" />
        <param name="MissionVariant" default="null" />
        <param name="OverrideName" default="null" />
        <param name="OverrideDescription" default="null" />
        <param name="ReportSignalCue" default="null" />
        <param name="DebugChance" default="0" />
      </params>
      <actions>
        <set_value name="$Feedback" exact="0" />
        <do_if value="not $MissionStation.exists">
          <set_value name="$Feedback" exact="-101" />
        </do_if>
      </actions>
      <cues>
        <cue name="Do_Not_Start_Mission" onfail="cancel">
          <conditions>
            <check_value value="$Feedback" exact="0" negate="true" />
          </conditions>
          <actions>
            <signal_cue cue="CleanUp" />
          </actions>
        </cue>
        <!--
        Mission Variation #1: Mass Traffic Criminal
          Licence: None
          Mission Level: 2
          Enemy Faction: Smuggler, Criminal-->
        <cue name="Check_Variation_1" instantiate="true">
          <conditions>
            <event_cue_signalled />
          </conditions>
          <actions>
            <set_value name="this.$SetupVariation" exact="event.param.{1}" />
            <set_value name="$VariationResult" exact="false" />
            <create_list name="$PossibleFactions" />
            <set_value name="this.$FactionExists" exact="false" />
            <do_all exact="100">
              <do_if value="$Get_Mission_Factions_Result.indexof.{faction.criminal}">
                <set_value name="this.$FactionExists" exact="true" />
                <append_to_list name="$PossibleFactions" exact="faction.criminal" chance="30" />
              </do_if>
              <do_if value="$Get_Mission_Factions_Result.indexof.{faction.smuggler}">
                <set_value name="this.$FactionExists" exact="true" />
                <append_to_list name="$PossibleFactions" exact="faction.smuggler" chance="70" />
              </do_if>
              <do_if value="not this.$FactionExists">
                <break />
              </do_if>
              <do_elseif value="$PossibleFactions.count" min="1">
                <set_value name="$VariationResult" exact="true" />
                <break />
              </do_elseif>
            </do_all>
            <do_if value="$VariationResult and this.$SetupVariation">
              <set_value name="$TextOffset" exact="100" />
              <set_value name="$MissionLevel" exact="2" />
              <set_value name="$TargetNPC__Faction" exact="$PossibleFactions.random" />
              <do_if value="$TargetNPC__Faction" exact="faction.smuggler">
                <do_any>
                  <set_value name="$Difficulty" exact="level.veryeasy" weight="10" />
                  <set_value name="$Difficulty" exact="level.easy" weight="25" />
                  <set_value name="$Difficulty" exact="level.medium" weight="30" />
                </do_any>
              </do_if>
              <do_elseif value="$TargetNPC__Faction" exact="faction.criminal">
                <do_any>
                  <set_value name="$Difficulty" exact="level.medium" weight="30" />
                  <set_value name="$Difficulty" exact="level.hard" weight="25" />
                  <set_value name="$Difficulty" exact="level.veryhard" weight="10" />
                </do_any>
              </do_elseif>
              <do_else>
                <set_value name="$Difficulty" exact="level.medium" weight="30" />
              </do_else>
            </do_if>
          </actions>
        </cue>
        <cue name="Do_Start_Mission" onfail="cancel">
          <conditions>
            <check_value value="$Feedback" exact="0" />
          </conditions>
          <actions>
            <set_value name="$Client_Owner" exact="$MissionStation.owner" />
            <signal_cue_instantly cue="md.LIB_Factions.Get_Mission_Factions" param="[Start, $MissionStation.cluster]" />
            <do_if value="$Get_Mission_Factions_Result.indexof.{$Client_Owner}">
              <remove_value name="$Get_Mission_Factions_Result.{$Get_Mission_Factions_Result.indexof.{$Client_Owner}}" />
            </do_if>
            <do_if value="$TargetStation == null">
              <set_value name="$TargetStation" exact="$MissionStation" />
            </do_if>
            <do_if value="not $TargetStation.hasmasstraffic">
              <set_value name="$Feedback" exact="-102" />
            </do_if>
            <do_if value="$Feedback" exact="0">
              <do_if value="$MissionVariant">
                <do_if value="$MissionVariant" min="1">
                  <do_if value="$MissionVariant == 1">
                    <signal_cue_instantly cue="Check_Variation_1" param="[false]" />
                  </do_if>
                  <do_if value="not $VariationResult">
                    <debug_text text="'Mission can not spawn variant ' + $MissionVariant" chance="$DebugChance" />
                    <set_value name="$MissionVariant" exact="0" />
                  </do_if>
                </do_if>
              </do_if>
              <do_else>
                <create_list name="$PossibleVariants" />
                <signal_cue_instantly cue="Check_Variation_1" param="[false]" />
                <do_if value="$VariationResult">
                  <append_to_list name="$PossibleVariants" exact="1" />
                </do_if>
                <set_value name="$VariationResult" exact="null" />
                <debug_text text="'Possible Variants: ' + $PossibleVariants" chance="$DebugChance" />
                <do_if value="$PossibleVariants.count" min="1">
                  <set_value name="$MissionVariant" list="$PossibleVariants" />
                </do_if>
              </do_else>
              <do_if value="$MissionVariant">
                <do_if value="$MissionVariant" exact="1">
                  <signal_cue_instantly cue="Check_Variation_1" param="[true]" />
                </do_if>
                <do_if value="not $TextOffset">
                  <set_value name="$Feedback" exact="-104" />
                </do_if>
              </do_if>
              <do_else>
                <set_value name="$Feedback" exact="-105" />
              </do_else>
            </do_if>
            <remove_value name="$Get_Mission_Factions_Result" />
            <do_if value="$Feedback" exact="0">
              <create_cue_actor cue="Start" name="$Client">
                <select faction="$Client_Owner" />
                <owner exact="$Client_Owner" />
              </create_cue_actor>
              <create_cue_actor cue="Start" name="$TargetActor">
                <select faction="$TargetNPC__Faction" />
                <owner exact="$TargetNPC__Faction" />
              </create_cue_actor>
              <set_owner object="$TargetActor" faction="$TargetNPC__Faction" />
              <create_group groupname="$TargetActors" />
              <do_if value="$OverrideName">
                <set_value name="$MissionName" exact="$OverrideName" />
              </do_if>
              <do_else>
                <set_value name="$MissionName" exact="readtext.{$Page}.{$TextOffset + 1}" />
              </do_else>
              <do_if value="$OverrideDescription">
                <set_value name="$Description" exact="$OverrideDescription" />
              </do_if>
              <do_else>
                <set_value name="$Description" exact="readtext.{$Page}.{$TextOffset + 2}" />
              </do_else>
              <do_if value="$Client_Owner">
                <do_if value="not $RewardCr">
                  <signal_cue_instantly cue="md.LIB_Reward_Balancing.Reward_Money" param="[Start, $Difficulty, $MissionLevel, $Client_Owner]" />
                  <set_value name="$RewardCr" exact="$Reward_Money__Result" />
                </do_if>
                <do_if value="not $RewardNotoriety">
                  <signal_cue_instantly cue="md.LIB_Reward_Balancing.Reward_Notoriety" param="[Start, $Difficulty, $MissionLevel, $Client_Owner]" />
                  <set_value name="$RewardNotoriety" exact="$Reward_Notoriety__Result" />
                </do_if>
              </do_if>
              <set_value name="$TargetShip" exact="null" />
            </do_if>
            <do_else>
              <signal_cue cue="CleanUp" />
              <cancel_cue cue="Do_Start_Mission" />
            </do_else>
          </actions>
          <cues>
            <cue name="With_Offer" onfail="cancel">
              <conditions>
                <check_value value="$WithoutOffer" exact="false" />
              </conditions>
              <cues>
                <cue name="MissionLocationOffer" onfail="cancel">
                  <conditions>
                    <check_value value="not $EventOffer" />
                  </conditions>
                  <cues>
                    <cue name="CreateOffer" ref="md.GenericMissions.OfferInSpace">
                      <param name="BaseCue" value="Start" />
                      <param name="CleanupCue" value="OfferRemoved" />
                      <param name="Station" value="$MissionStation" />
                      <param name="Client" value="$Client" />
                      <param name="MissionName" value="$MissionName" />
                      <param name="Description" value="$Description" />
                      <param name="Reward" value="$RewardCr" />
                      <param name="MissionDuration" value="$MissionDuration" />
                      <param name="Difficulty" value="$Difficulty" />
                      <param name="TimeoutMin" value="8min" />
                      <param name="TimeoutMax" value="12min" />
                      <param name="Faction" value="$Client_Owner" />
                      <param name="MissionType" value="missiontype.kill" />
                      <param name="AcceptCue" value="MissionAccepted" />
                      <param name="CompleteCue" value="AddOfferSteps" />
                    </cue>
                    <cue name="OfferRemoved">
                      <conditions>
                        <event_cue_signalled />
                      </conditions>
                      <actions>
                        <set_value name="$Feedback" exact="-3" />
                        <signal_cue cue="CleanUp" />
                      </actions>
                    </cue>
                  </cues>
                </cue>
                <cue name="EventOffer" onfail="cancel">
                  <conditions>
                    <check_value value="$EventOffer" />
                  </conditions>
                  <actions>
                    <set_value name="$Event_Timeout" exact="md.$InteractiveMissionOfferTimeout" />
                    <play_cutscene key="'ShowPilot'" eventmonitor="true" timeout="$Event_Timeout">
                      <interaction text="$MissionName" param="$Client" param2="'GM_Assassination__Offer'" />
                      <param name="npcref" object="$Client" />
                    </play_cutscene>
                  </actions>
                  <cues>
                    <cue name="EventOffer_Wait">
                      <delay exact="50ms" />
                      <actions>
                        <speak actor="$Client" line="1" />
                      </actions>
                    </cue>
                    <cue name="EventOffer_Interact">
                      <conditions>
                        <event_player_interaction param="$Client" param2="'GM_Assassination__Offer'" />
                      </conditions>
                      <actions>
                        <stop_cutscene key="'ShowPilot'" />
                        <cancel_cue cue="EventOffer_Timeout" />
                        <start_conversation actor="$Client" conversation="assassinate" />
                        <create_offer cue="Start" name="$MissionName" description="$Description" difficulty="$Difficulty" actor="$Client" faction="$Client_Owner" duration="$MissionDuration" type="$MissionType" reward="$RewardCr" />
                        <signal_cue cue="AddOfferSteps" />
                      </actions>
                    </cue>
                    <cue name="EventOffer_Timeout">
                      <delay exact="$Event_Timeout" />
                      <actions>
                        <set_value name="$Feedback" exact="-5" />
                        <signal_cue cue="CleanUp" />
                      </actions>
                    </cue>
                  </cues>
                </cue>
                <cue name="AddOfferSteps">
                  <conditions>
                    <event_cue_signalled />
                  </conditions>
                  <actions>
                    <update_offer cue="Start">
                      <briefing>
                        <objective step="1" action="objective.kill" text="$TargetActor.name" />
                      </briefing>
                    </update_offer>
                  </actions>
                </cue>
                <cue name="ShowOffer">
                  <conditions>
                    <event_offer_accepted cue="Start" />
                  </conditions>
                  <actions>
                    <start_conversation conversation="assassinate" actor="$Client" />
                  </actions>
                  <cues>
                    <cue name="ShowOffer_KeepAlive" checkinterval="1min">
                      <conditions>
                        <check_value value="false" />
                      </conditions>
                    </cue>
                  </cues>
                </cue>
                <cue name="ConversationStart" instantiate="true">
                  <conditions>
                    <check_any>
                      <event_conversation_started actor="$Client" />
                      <event_conversation_returned_to_section actor="$Client" />
                    </check_any>
                  </conditions>
                  <actions>
                    <add_conversation_view view="facenormal" />
                    <do_if value="event.name" exact="'event_conversation_started'">
                      <add_npc_line line="3001" />
                    </do_if>
                    <add_player_choice text="{1002,14001}" position="top_right" section="assassinate_accept" />
                    <add_player_choice text="{1002,14002}" position="bottom_right" section="assassinate_decline" />
                    <add_player_choice_sub text="{1002,14003}" position="left" section="assassinate_moreinfo" choiceparam="[0, 0, Start, true]" />
                  </actions>
                </cue>
                <cue name="ConversationNextSection" instantiate="true">
                  <conditions>
                    <event_conversation_next_section actor="$Client" />
                  </conditions>
                  <actions>
                    <do_if value="event.param == 'assassinate_moreinfo'">
                      <open_conversation_menu menu="MissionBriefingMenu" param="event.param2" param2="event.param3" />
                      <add_conversation_view view="facedetailmonitor" />
                      <add_npc_line speaker="$Client" line="3037" />
                      <!--<add_npc_line line="3102" />
                          <add_player_choice text="{1002,14001}" position="top_right" section="assassinate_accept" />
                          <add_player_choice text="{1002,14002}" position="bottom_right" section="assassinate_decline" />-->
                    </do_if>
                    <do_elseif value="event.param == 'assassinate_accept'">
                      <include_actions ref="FindTarget" />
                      <do_if value="$TargetActors.count" min="1">
                        <add_npc_line line="3031" />
                        <signal_cue cue="MissionAccepted" />
                      </do_if>
                      <do_else>
                        <add_npc_line line="3035" />
                        <reset_cue cue="ShowOffer" />
                      </do_else>
                    </do_elseif>
                    <do_else>
                      <do_if value="$EventOffer">
                        <remove_offer cue="Start" />
                        <set_value name="$Feedback" exact="-4" />
                        <signal_cue cue="CleanUp" />
                      </do_if>
                      <do_else>
                        <add_npc_line line="13" />
                        <reset_cue cue="ShowOffer" />
                      </do_else>
                    </do_else>
                  </actions>
                </cue>
                <cue name="AfterConversationAccept" instantiate="true">
                  <conditions>
                    <event_conversation_finished actor="$Client" outcome="assassinate_accept" />
                  </conditions>
                  <delay exact="2s" />
                  <actions>
                    <speak actor="player.copilot" line="9" />
                  </actions>
                </cue>
                <cue name="EndEventConversation">
                  <conditions>
                    <event_conversation_finished actor="$Client" />
                    <check_value value="event.param" exact="'assassinate_accept'" negate="true" />
                    <check_value value="$EventOffer" />
                  </conditions>
                  <actions>
                    <remove_offer cue="Start" />
                    <set_value name="$Feedback" exact="-4" />
                    <signal_cue cue="CleanUp" />
                  </actions>
                </cue>
              </cues>
            </cue>
            <cue name="Without_Offer" onfail="cancel">
              <conditions>
                <check_value value="$WithoutOffer" exact="true" />
              </conditions>
              <actions>
                <include_actions ref="FindTarget" />
                <do_if value="$TargetActors.count" min="1">
                  <signal_cue cue="MissionAccepted" />
                </do_if>
                <do_else>
                  <set_value name="$Feedback" exact="-103" />
                  <signal_cue cue="CleanUp" />
                </do_else>
              </actions>
            </cue>
            <library name="FindTarget">
              <actions>
                <do_if value="$TargetShip == null">
                  <request_mass_traffic_ship name="$MassTrafficShip" zone="$TargetStation.zone" start="$TargetStation" />
                  <destroy_object object="$MassTrafficShip.pilot" />
                  <assign_pilot actor="$TargetActor" object="$MassTrafficShip" />
                  <set_owner object="$MassTrafficShip" faction="$TargetActor.owner" />
                  <remove_value name="$MassTrafficShip" />
                </do_if>
                <do_else>
                  <set_value name="$TargetActor" exact="$TargetShip.pilot" />
                </do_else>
                <do_if value="$TargetActor.exists">
                  <add_to_group groupname="$TargetActors" object="$TargetActor" />
                </do_if>
              </actions>
            </library>
            <cue name="BriefingStarted">
              <conditions>
                <event_briefing_started cue="Start" />
              </conditions>
              <actions>
                <do_if value="$TargetActors.count" min="1">
                  <set_value name="$BriefingCutsceneStarted" />
                  <set_value name="$CutsceneKey" exact="'OrbitIndefinitely'" />
                  <play_cutscene key="$CutsceneKey" rendertarget="event.param.{1}">
                    <param name="targetobject" object="$TargetActors.{1}.ship" />
                  </play_cutscene>
                </do_if>
                <do_else>
                  <do_if value="not $HoloMap?">
                    <add_holomap name="$HoloMap" rendertarget="$RenderTarget" />
                  </do_if>
                </do_else>
                <debug_text text="'Briefing started'" chance="$DebugChance" />
              </actions>
              <cues>
                <cue name="DisplayHolomap" onfail="cancel">
                  <conditions>
                    <check_value value="$HoloMap?" />
                  </conditions>
                  <cues>
                    <cue name="HolomapRef" ref="md.LIB_HolomapTarget.Start">
                      <param name="EndSignalCue" value="HolomapEnd" />
                      <param name="HoloMap" value="$HoloMap" />
                      <param name="Components" value="[player.primaryship, $TargetStation.zone]" />
                      <param name="ShowUnknown" value="true" />
                    </cue>
                    <cue name="HolomapEnd">
                      <conditions>
                        <event_cue_signalled />
                      </conditions>
                      <actions>
                        <debug_text text="'Holomap end'" />
                      </actions>
                    </cue>
                  </cues>
                </cue>
                <cue name="BriefingStopped">
                  <conditions>
                    <event_briefing_cancelled cue="Start" />
                  </conditions>
                  <actions>
                    <do_if value="$BriefingCutsceneStarted?">
                      <remove_value name="$BriefingCutsceneStarted" />
                      <stop_cutscene key="$CutsceneKey" />
                    </do_if>
                    <do_if value="$HoloMap?">
                      <remove_holomap />
                      <remove_value name="$HoloMap" />
                    </do_if>
                    <debug_text text="'Briefing canceled'" chance="$DebugChance" />
                    <reset_cue cue="BriefingStarted" />
                  </actions>
                </cue>
              </cues>
            </cue>
            <cue name="MissionAccepted">
              <conditions>
                <event_cue_signalled />
              </conditions>
              <actions>
                <debug_text text="'Mission accepted!'" chance="$DebugChance" />
                <set_value name="stat.missions_accepted" operation="add" />
                <do_if value="$WithoutOffer">
                  <create_mission cue="Start" name="$MissionName" description="$Description" difficulty="$Difficulty" faction="$Client_Owner" type="missiontype.kill" reward="$RewardCr" />
                </do_if>
                <do_else>
                  <create_mission cue="Start" offercue="Start" />
                  <remove_offer cue="Start" />
                  <cancel_cue cue="With_Offer" />
                </do_else>
                <signal_cue_instantly cue="md.GenericMissions.GenericAcceptLogbookEntry" param="[$MissionName, $Client, $Client_Owner]" />
              </actions>
              <cues>
                <cue name="DestroyEntities_ref" ref="md.RML_Destroy_Entities.DestroyEntities">
                  <param name="EndSignalCue" value="MissionEnded" />
                  <param name="MissionCue" value="Start" />
                  <param name="StartStep" value="1" />
                  <param name="Targets_Param" value="$TargetActors" />
                  <param name="Objective" value="objective.kill" />
                  <param name="DebugChance" value="$DebugChance" />
                </cue>
                <cue name="Aborted">
                  <conditions>
                    <event_mission_aborted cue="Start" />
                  </conditions>
                  <actions>
                    <signal_cue_instantly cue="md.GenericMissions.GenericAbortLogbookEntry" param="[$MissionName, $Client]" />
                    <set_value name="$Feedback" exact="-2" />
                    <remove_mission cue="Start" type="aborted" />
                    <signal_cue cue="CleanUp" />
                  </actions>
                </cue>
                <cue name="MissionTimeout" onfail="cancel">
                  <conditions>
                    <check_value value="typeof $MissionDuration == datatype.time" />
                    <check_value value="$MissionDuration" min="1s" />
                  </conditions>
                  <delay exact="$MissionDuration" />
                  <actions>
                    <signal_cue_instantly cue="md.GenericMissions.GenericTimeoutLogbookEntry" param="[$MissionName, $Client]" />
                    <remove_mission cue="Start" type="failed" />
                    <set_value name="$Feedback" exact="-6" />
                    <signal_cue_instantly cue="CleanUp" />
                  </actions>
                </cue>
                <cue name="MissionEnded">
                  <conditions>
                    <event_cue_signalled />
                  </conditions>
                  <actions>
                    <do_if value="MissionEnded.$EndFeedbackValue" max="-1">
                      <debug_text text="'This mission has failed with RML feedback: ' + MissionEnded.$EndFeedbackValue" chance="$DebugChance" />
                      <set_value name="$Feedback" exact="-1" />
                      <speak actor="$Client" line="3046" />
                      <signal_cue_instantly cue="md.GenericMissions.GenericFailLogbookEntry" param="[$MissionName, $Client]" />
                      <remove_mission cue="Start" type="failed" />
                    </do_if>
                    <do_else>
                      <debug_text text="'This mission has successfully finished with RML feedback: ' + MissionEnded.$EndFeedbackValue" chance="$DebugChance" />
                      <do_if value="$RewardNotoriety and $Client_Owner">
                        <debug_text text="'Relation was: ' + player.entity.relationto.{$Client_Owner}" chance="$DebugChance" />
                        <add_faction_relation faction="faction.player" otherfaction="$Client_Owner" value="$RewardNotoriety" />
                        <debug_text text="'Relation is now: ' + player.entity.relationto.{$Client_Owner}" chance="$DebugChance" />
                      </do_if>
                      <reward_player money="$RewardCr" />
                      <show_notification caption="{1015,40}.[$RewardCr.formatted.default]" icon="achievement_money_up" queued="true" sound="ui_mon_eve_money_up" />
                      <set_value name="stat.missions_completed" operation="add" />
                      <set_value name="$Feedback" exact="1" />
                      <speak actor="$Client" line="3042" />
                      <signal_cue_instantly cue="md.GenericMissions.GenericCompleteLogbookEntry" param="[$MissionName, $Client, null, $RewardCr]" />
                      <remove_mission cue="Start" type="completed" />
                    </do_else>
                    <signal_cue cue="CleanUp" />
                  </actions>
                </cue>
              </cues>
            </cue>
          </cues>
        </cue>
        <cue name="CleanUp">
          <conditions>
            <event_cue_signalled />
          </conditions>
          <actions>
            <do_if value="$BriefingCutsceneStarted?">
              <remove_value name="$BriefingCutsceneStarted" />
              <stop_cutscene key="$CutsceneKey" />
            </do_if>
            <do_if value="$HoloMap?">
              <remove_holomap />
              <remove_value name="$HoloMap" />
            </do_if>
            <do_if value="@$Client.isclass.npc">
              <destroy_object object="$Client" />
            </do_if>
            <do_if value="@$TargetActor.ship.pilot.exists">
              <do_if value="$TargetActor.ship.pilot == $TargetActor">
                <start_script name="'masstraffic.return'" object="$TargetActor" />
              </do_if>
            </do_if>
            <do_all chance="$DebugChance">
              <do_if value="$Feedback" exact="-105">
                <debug_text text="'No suitable mission variant'" />
              </do_if>
              <do_elseif value="$Feedback" exact="-104">
                <debug_text text="'Unknown mission variant. No TextOffset set'" />
              </do_elseif>
              <do_elseif value="$Feedback" exact="-103">
                <debug_text text="'No target found'" />
              </do_elseif>
              <do_elseif value="$Feedback" exact="-102">
                <debug_text text="'TargetStation does not have masstraffic'" />
              </do_elseif>
              <do_elseif value="$Feedback" exact="-101">
                <debug_text text="'No MissionStation parameter provided'" />
              </do_elseif>
              <do_elseif value="$Feedback" exact="-6">
                <debug_text text="'Mission timeout'" />
              </do_elseif>
              <do_elseif value="$Feedback" exact="-5">
                <debug_text text="'Event Offer timeout'" />
              </do_elseif>
              <do_elseif value="$Feedback" exact="-4">
                <debug_text text="'Player declined event offer'" />
              </do_elseif>
              <do_elseif value="$Feedback" exact="-3" />
              <do_elseif value="$Feedback" exact="-2">
                <debug_text text="'Mission aborted'" />
              </do_elseif>
              <do_elseif value="$Feedback" exact="-1">
                <debug_text text="'Mission failed'" />
              </do_elseif>
              <do_elseif value="$Feedback" exact="1">
                <debug_text text="'Mission suceeded'" />
              </do_elseif>
              <do_else>
                <debug_text text="'ERROR: Assassination.Cleanup - unknown Feedback value. Default to -100'" />
                <set_value name="$Feedback" exact="-100" />
              </do_else>
            </do_all>
            <do_if value="$ReportSignalCue != null">
              <set_value name="$ReportSignalCue.$EndFeedbackValue" exact="$Feedback" />
              <signal_cue cue="$ReportSignalCue" />
            </do_if>
            <cancel_cue cue="Start" />
          </actions>
        </cue>
      </cues>
    </library>
  </cues>
</mdscript>